# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
    
  issues: 
    types: [opened]
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      environment: ${{ steps.extract_version.outputs.environment }}

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a set of commands using the runners shell

      - name: Extract Version from Issue Body
        env:
          ISSUE_BODY=${{ github.event.issue.body }}
        id: extract_version
        run: |
          # Extract the version using grep and awk
          VERSION=$(echo "$ISSUE_BODY" | grep -Eo 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)

          ENVIRONMENT=$(echo "$ISSUECONTENTS" | awk '/### Environment/ {getline; print}' | awk '{$1=$1};1')
          
          # Output the extracted version
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT  
        shell: bash

      - name: Print Extracted Version
        run: echo "Extracted Version ${{ env.VERSION }}"

  verify_output:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - run: echo ${{ needs.build.outputs.version }} ${{ needs.build.outputs.environment }}

  calling:
    needs: build
    uses: ./.github/workflows/callable-workflow.yml
    if: ${{ needs.build.outputs.output2 == 'ute' }} 
    with:
      environment: 'ute'
      version: '1.2.4'




        





